/*! visualnoveljs v0.0.1 2014-09-27 */
function VisualNovel(a,b,c,d){return this instanceof VisualNovel?(this.novelId=a,this.novelTitle="",this.novelSubtitle="",this.novelMode="dialog",this.imgPath=d?d:"",this.novelContainerId=null,this.screenStartId=null,this.screenStartMenuButtonContainerId=null,this.screenStartMenuStartButtonId=null,this.novelModeId=null,this.dialogModeId=null,this.dialogButtonId=null,this.dialogImageId=null,this.dialogTextId=null,this.dialogMenuId=null,this.screenCharacterId=null,this.screenSceneId=null,this.screenBgId=null,this.sceneContainer=null,this.sceneFloor=null,this.scenes={text:[],object:[]},this.characterContainer=null,this.characters=[],this.menuChoicesTaken={},this.menuChoices={},this.userInput={},this.timers={},this.screenWidth=b,this.screenHeight=c,this.dialogWidth=b,this.dialogHeight=150,this.dialogPadding={top:10,right:10,bottom:10,left:10},this.dialogBorder={top:10,right:50,bottom:10,left:50},this.dialogTextColor="white",this.dialogBgColor="rgba(0,0,0,0.5)",this.dialogButtonSize={width:40,height:30},this.dialogButtonPos={left:b-this.dialogPadding.right-this.dialogButtonSize.width,bottom:0},this.dialogCharacter=null,this.sceneHeight=this.screenHeight-this.dialogHeight,this.sceneFloorHeight=c>b?c:b,this.sceneFloorWidth=c>b?c:b,this.init(a),this):new VisualNovel(b,c,d)}function EventTracker(){return this instanceof EventTracker?(this.doRepeatEvent=!1,this.eventsInProgress=["main"],this.eventList={main:[]},this.eventId={main:0},this.save={eventsInProgress:[],eventId:{}},this):new EventTracker}function Util(){return this instanceof Util?this:new Util}function vector2D(a,b,c,d){var e=a[c],f=a[d],g=b[c],h=b[d],i=Math.abs(g-e),j=Math.abs(h-f),k=g>e?1:-1,l=h>f?1:-1;if(i>j)var m=i,n=c.slice(),o=k,p=l*(j/i);else var m=j,n=d.slice(),o=k*(i/j),p=l;var q={axis:n,maxDifference:m};return q[c]=o,q[d]=p,q}function Parser(){return this instanceof Parser?(Util.apply(this,arguments),this):new Parser}function ObjectFactory(a){var b=null;if("SceneObject"===a&&(b=SceneObject.apply({},[].slice.call(arguments,1))),"Character"===a&&(b=Character.apply({},[].slice.call(arguments,1))),"SpriteContainer"===a&&(b=new Sprite3D(arguments[1]),b.addChild(Sprite3D.createCenteredContainer())),"ScreenBg"===a&&(b=new Sprite3D(arguments[1]),b.addChild(Sprite3D.createCenteredContainer()),b.sprite=b,b.timer={},b.rotate=Sprite.prototype.rotate,b.rotateTo=Sprite.prototype.rotateTo,b.fade=Sprite.prototype.fade,b.fadeIn=Sprite.prototype.fadeIn,b.fadeOut=Sprite.prototype.fadeOut),"SceneFloor"===a){var c=arguments[1],d=arguments[2],e={x:-(c/2),y:-(d/2),z:-50},f={x:0,y:0},g={x:-90,y:0,z:0};b=new Sprite(c,d,e,f,g)}return"SceneFloorContainer"===a&&(b=(new Sprite3D).setClassName("sceneFloorContainer").setZ(0).rotateX(-20).update()),b}function TemplateFactory(a){var b="";return"novelcontainer"===a&&(b=["<div class='novel-container unSelectable'>","<div id='{novelId}-screen-start' class='novel screen-start'></div>","<div id='{novelId}-dialog-menu' class='novel dialog-menu'></div>","<div id='{novelId}-dialog-novelmode' class='novel dialog-novelmode'></div>","<div id='{novelId}-dialog-dialogmode' class='novel dialog-dialogmode'></div>","<div id='{novelId}-screen-character' class='novel screen-character'></div>","<div id='{novelId}-screen-scene' class='novel screen-scene'></div>","<div id='{novelId}-screen-bg' class='novel screen-bg'></div>","</div>"]),"startmenu"===a&&(b=["<div id='{novelId}-novelTitleContainer' class='novelTitleContainer'>","<div id='{novelId}-novelTitleText' class='novelTitleText'>{novelTitle}</div>","<div id='{novelId}-novelSubtitleText' class='novelSubtitleText'>{novelSubtitle}</div>","</div>","<div id='{novelId}-startMenuButtonContainer' class='startMenuButtonContainer'>","<button id='{novelId}-startMenuButton' class='startMenuButton' >","START</button>","</div>"]),"say"===a&&(b=["<if={showDialogImage}><img id='{novelId}-dialog-dialogImage' src='{dialogImage}' style='float:{dialogImageLocation};width:{dialogImageWidth};height:{dialogImageHeight};{dialogImageBorder}' /></if>","<div id='{novelId}-dialog-dialogName' class='dialogName'>{name}</div>","<div id='{novelId}-dialog-dialogText' class='dialogText'>{dialogLine}</div>","<if={showButtonText}><button id='{novelId}-dialog-dialogButton' class='dialogButton'>{dialogButtonText}</button></if>","<if={showButtonImage}><img id='{novelId}-dialog-dialogButton' class='dialogButton' src='{dialogButtonImage}' style='width:{dialogButtonImageWidth};height:{dialogButtonImageHeight};' /></if>"]),"userinput"===a&&(b=["<div id='userInputContainer' class='userInputContainer'>","<div id='userInputMessage' class='userInputMessage'>{message}</div><hr/><br/>","<input id='{novelId}-userInputText' class='userInputText' type='text' /><br/><br/>","<input type='button' id='{novelId}-userInputButton' class='userInputButton' value='OK' />","</div>"]),"menuchoice"===a&&(b=["<div id='{novelId}-dialogMenuChoiceContainer' class='dialogMenuChoiceContainer'>","<div id='{novelId}-dialogMenuChoiceButtonsContainer' class='dialogMenuChoiceButtonsContainer'>","<foreach={choice in choices}>","<button class='dialogMenuChoiceButton' id='{novelId}-dialogMenuChoiceButton{index}' >","{choice.label}","</button><br/>","</foreach>","</div>","<div id='{novelId}-dialogMenuChoiceImageContainer' class='dialogMenuChoiceImageContainer'>","<if={imgPath}><img src='{imgPath}' style='width:{imgWidth}px;height:{imgHeight}px;' /></if>","</div>","</div>"]),b.join("")}function Effect(a,b){return this instanceof Effect?(this.screenWidth=a,this.screenHeight=b,this):new Effect}function Sprite(a,b,c,d,e){return this instanceof Sprite?(this.init(a,b,c,d,e),this):new Sprite(a,b,c,d,e)}function Character(a,b,c,d,e){return this instanceof Character?(Sprite.apply(this,arguments),this.init(a,b,c,d,e),this):new Character(a,b,c,d,e)}function SceneObject(a,b,c,d,e){return this instanceof SceneObject?(Sprite.apply(this,arguments),this.init(a,b,c,d,e),this):new SceneObject(a,b,c,d,e)}VisualNovel.prototype.init=function(a){this.initObjects(),this.initContainers(a),this.initScreenStart(a)},VisualNovel.prototype.initObjects=function(){this.util=new Util,this.parser=new Parser,this.eventTracker=new EventTracker},VisualNovel.prototype.initContainers=function(a){this.initNovelContainer(a),this.initSceneContainer(),this.initDialogMenuContainer(),this.initNovelModeContainer(),this.initDialogModeContainer(),this.initCharacterContainer(),this.initBGContainer()},VisualNovel.prototype.pause=function(a){function b(){setTimeout(function(){c.eventTracker.nextEvent()},a)}var c=this;this.eventTracker.addEvent("wait",b)},VisualNovel.prototype.repeatEvent=function(){function a(){b.eventTracker.doRepeatEvent=!0}var b=this;this.eventTracker.addEvent("nowait",a)},VisualNovel.prototype.reset=function(){function a(){b.resetNovel(),b.showStartScreen(!0)}var b=this;this.eventTracker.addEvent("wait",a)},VisualNovel.prototype.resetNovel=function(){this.eventTracker.resetEventsInProgress(),this.resetMenuChoices(),this.resetCharacters(),this.resetScenes()},VisualNovel.prototype.setNovelTitle=function(a,b){this.updateNovelTitleModel(a,b),this.updateNovelTitleView(a,b)},VisualNovel.prototype.updateNovelTitleModel=function(a,b){this.novelTitle=a,this.novelSubtitle=b},VisualNovel.prototype.updateNovelTitleView=function(a,b){this.novelTitleTextId.innerHTML=a,this.novelSubtitleTextId.innerHTML=b},VisualNovel.prototype.setNovelTitlePosition=function(a,b){var c=this.novelTitleContainerId.style,d=this.util.scalePosition({x:a,y:b},{x:this.screenWidth,y:this.screenHeight});c.left=d.x+"px",c.top=d.y+"px"},VisualNovel.prototype.setNovelMode=function(a,b,c,d,e){function f(){g.novelMode=a?a:"dialog",h&&(g.setDialogModeContainerSize(b,c),g.setDialogButtonPosition(b-g.dialogPadding.right-g.dialogButtonSize.width)),i&&g.setDialogModeContainerPosition(d,e)}var g=this,h="undefined"!=typeof b&&"undefined"!=typeof c,i="undefined"!=typeof d&&"undefined"!=typeof e;this.eventTracker.addEvent("nowait",f)},VisualNovel.prototype.initNovelContainer=function(a){this.novelContainerId=document.getElementById(a),this.buildNovelContainer(a),this.updateNovelContainerReference(a),this.setNovelContainerSize(this.screenWidth,this.screenHeight,a)},VisualNovel.prototype.buildNovelContainer=function(a){var b=TemplateFactory("novelcontainer");b=this.parser.parseTemplate(b,{novelId:a}),this.novelContainerId.innerHTML=b},VisualNovel.prototype.updateNovelContainerReference=function(a){this.screenStartId=document.getElementById(a+"-screen-start"),this.novelModeId=document.getElementById(a+"-dialog-novelmode"),this.dialogModeId=document.getElementById(a+"-dialog-dialogmode"),this.dialogMenuId=document.getElementById(a+"-dialog-menu"),this.screenCharacterId=document.getElementById(a+"-screen-character"),this.screenSceneId=document.getElementById(a+"-screen-scene"),this.screenBgId=document.getElementById(a+"-screen-bg")},VisualNovel.prototype.setNovelContainerSize=function(a,b){var c=this.novelContainerId,d=c?c.getElementsByClassName("novel"):[],e=null,f=this.novelContainerId.style;f.overflow="hidden",f.width=this.screenWidth+"px",f.height=this.screenHeight+"px",this.util.foreach(d,function(c){e=c.style,e.width=a+"px",e.height=b+"px"})},VisualNovel.prototype.initScreenStart=function(a){var b=this;this.buildStartMenu(a),this.updateStartMenuReference(a),this.showStartScreen(!0),this.screenStartMenuStartButtonId.onclick=function(){b.startNovel()}},VisualNovel.prototype.startNovel=function(){this.showStartScreen(!1),this.eventTracker.startEvent()},VisualNovel.prototype.buildStartMenu=function(a){var b=this.screenStartId,c=TemplateFactory("startmenu"),d={novelId:a,novelTitle:this.novelTitle,novelSubtitle:this.novelSubtitle};c=this.parser.parseTemplate(c,d),b.innerHTML=c},VisualNovel.prototype.updateStartMenuReference=function(a){this.novelTitleContainerId=document.getElementById(a+"-novelTitleContainer"),this.novelTitleTextId=document.getElementById(a+"-novelTitleText"),this.novelSubtitleTextId=document.getElementById(a+"-novelSubtitleText"),this.screenStartMenuButtonContainerId=document.getElementById(a+"-startMenuButtonContainer"),this.screenStartMenuStartButtonId=document.getElementById(a+"-startMenuButton")},VisualNovel.prototype.showStartScreen=function(a){var b=a?"block":"none";this.screenStartId.style.display=b},VisualNovel.prototype.setStartScreenBgImage=function(a,b,c){var d=this.screenStartId.style;d["background-image"]="url('"+this.imgPath+a+"')",d["background-size"]=b+"px "+c+"px"},VisualNovel.prototype.setStartScreenBgColor=function(a){this.screenStartId.style["background-color"]=a},VisualNovel.prototype.setStartScreenMenuBgImage=function(a,b,c){var d=this.screenStartMenuButtonContainerId.style;d["background-image"]="url('"+this.imgPath+a+"')",d["background-size"]=b+"px "+c+"px"},VisualNovel.prototype.setStartScreenMenuBgColor=function(a){this.screenStartMenuButtonContainerId.style["background-color"]=a},VisualNovel.prototype.setStartScreenMenuPos=function(a,b){var c=a>1?a:a*this.screenHeight,d=b>1?b:b*this.screenWidth,e=this.screenStartMenuButtonContainerId.style;e.left=c+"px",e.top=d+"px"},VisualNovel.prototype.initSceneContainer=function(){var a=this.createSceneContainer(this.screenSceneId,this.sceneFloorWidth,this.sceneFloorHeight);this.sceneContainer=a.floorContainer,this.sceneFloor=a.floor},VisualNovel.prototype.createSceneContainer=function(a,b,c){var d=ObjectFactory("SpriteContainer",a),e=d.children[0],f=ObjectFactory("SceneFloor",b,c),g=ObjectFactory("SceneFloorContainer");g.addChild(f.sprite),e.addChild(g);var h={floorContainer:g,floor:f};return h},VisualNovel.prototype.rotateScene=function(a,b,c,d){function e(){f.sceneFloor.rotate(a,b,c,d)}var f=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.resetScenes=function(){for(var a=this.sceneContainer.children,b=a.length,c=b-1;c>=1;c--)this.sceneContainer.removeChildAt(c);this.scenes={text:[],object:[]}},VisualNovel.prototype.initDialogMenuContainer=function(){this.dialogMenuId.style.display="none"},VisualNovel.prototype.initNovelModeContainer=function(){this.novelModeId.style.display="none"},VisualNovel.prototype.initDialogModeContainer=function(){this.setSayDialogDisplay(!1),this.setDialogModeContainerSize(this.dialogWidth,this.dialogHeight),this.setDialogModeContainerPosition(0,this.sceneHeight),this.setDialogTextColor(this.dialogTextColor),this.setDialogBgColor(this.dialogBgColor)},VisualNovel.prototype.setDialogModeContainerSize=function(a,b){var c=this.dialogModeId.style,d=this.calculateDialogModeContainerSize(a,b);c.width=d.width,c.height=d.height,this.dialogWidth=a,this.dialogHeight=b},VisualNovel.prototype.calculateDialogModeContainerSize=function(a,b){var c={},d=this.dialogPadding,e=a?a:this.dialogWidth;c.width=e-d.left-d.right+"px";var f=b?b:this.dialogHeight;return c.height=f-d.top-d.bottom+"px",c},VisualNovel.prototype.setDialogModeContainerPosition=function(a,b){var c=this.dialogModeId.style,d=this.util.scalePosition({x:a?a:0,y:b?b:this.sceneHeight},{x:this.screenWidth,y:this.screenHeight});c.left=d.x+"px",c.top=d.y+"px"},VisualNovel.prototype.setDialogBgImage=function(a,b,c){var d=this.dialogModeId.style;a&&(d["background-img"]=a?"url('"+this.imgPath+a+"')":""),b&&c&&(d["background-size"]=b+"px "+c+"px")},VisualNovel.prototype.setDialogBgColor=function(a){this.dialogModeId.style["background-color"]=a?a:"black"},VisualNovel.prototype.setDialogTextColor=function(a){this.dialogModeId.style.color=a?a:"white"},VisualNovel.prototype.setDialogBorderStyle=function(a,b,c,d){var e=this.dialogModeId.style,f=(this.dialogPadding,a?"url('"+this.imgPath+a+"')":"",c?c:0),g=b?b:"rgba( 0, 0, 0, 0.5 )",h=d?d:0;e["border-width"]="string"==typeof f?f:f+"px",e["border-style"]="solid",e["border-color"]=g,e["border-radius"]="string"==typeof h?h:h+"px",this.setDialogModeContainerSize(this.dialogWidth,this.dialogHeight)},VisualNovel.prototype.setDialogButtonPosition=function(a,b){var c=this.dialogButtonPos;"undefined"!=typeof a&&(c.left=a),"undefined"!=typeof b&&(c.bottom=b)},VisualNovel.prototype.updateDialogButtonPosition=function a(b){var c="object"==typeof b?!0:!1,d=c&&b.dialog&&b.dialog.button?b.dialog.button:null,a=d&&d.width;a&&this.setDialogButtonPosition(this.dialogWidth-this.dialogPadding.right-this.dialogPadding.left-d.width)},VisualNovel.prototype.refreshDialogButtonPositionView=function(){var a=this.dialogButtonId.style;a.left=this.dialogButtonPos.left+"px",a.bottom=this.dialogButtonPos.bottom+"px"},VisualNovel.prototype.updateDialogButtonListeners=function(a){var b=this,c="object"==typeof a?!0:!1,d=c&&a.dialog?a.dialog:null,e=d&&a.dialog.button?a.dialog.button:null,f=this.dialogButtonId,g=this.dialogImageId,h=e&&e.bgColor&&e.bgColorHover,i=e&&e.bgColorHover?e.bgColorHover:"transparent",j=h?function(){f.style["background-color"]=i}:function(){},k=e&&e.bgColor?e.bgColor:"transparent",l=h?function(){f.style["background-color"]=k}:function(){},m=e&&e.image&&e.imageHover,n=e&&e.imageHover?this.imgPath+e.imageHover:"",o=m?function(){f.setAttribute("src",n)}:function(){},p=e&&e.image?this.imgPath+e.image:"",q=m?function(){f.setAttribute("src",p)}:function(){};f.onmouseover=function(){j(),o()},f.onmouseleave=function(){l(),q()};var r=function(){},s=null,t=d&&d.image?this.imgPath+d.image:"",u=d&&d.nextImage?this.imgPath+d.nextImage:"",v=d&&d.imageDelay?d.imageDelay:5e3;d&&d.nextImage&&(s=setInterval(function(){g.setAttribute("src",u),setTimeout(function(){g.setAttribute("src",t)},200)},v),r=function(){window.clearInterval(s)}),this.dialogButtonId.onclick=function(){b.eventTracker.nextEvent(),r()}},VisualNovel.prototype.initCharacterContainer=function(){var a=this.screenCharacterId.style;a.width=this.screenWidth+"px",a.height=this.screenHeight+"px",a.display="none",this.characterContainer=ObjectFactory("SpriteContainer",this.screenCharacterId)},VisualNovel.prototype.initBGContainer=function(){this.screenBgId=ObjectFactory("ScreenBg",this.screenBgId)},VisualNovel.prototype.setBgImage=function(a,b,c){function d(){var d=e.screenBgId;d.style["background-image"]="url('"+e.imgPath+a+"')",d.setPosition(0,0,0).setSize(b,c).update()}var e=this;this.eventTracker.addEvent("nowait",d)},VisualNovel.prototype.setBgColor=function(a){function b(){c.screenBgId.style["background-color"]=a}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.setBgSize=function(a,b,c,d){function e(){if(c){var d=vector2D(f.getBgSize(),{width:a,height:b},"width","height"),e=d.maxDifference/40/(c/1e3);d.width=d.width*e,d.height=d.height*e,f.setBgSizeByStep(a,b,25,d)}else f.setBgSizeTo(a,b);f.screenBgId.update()}var f=this;this.eventTracker.addEvent("nowait",e,d)},VisualNovel.prototype.setBgSizeByStep=function(a,b,c,d){var e=this.getBgSize(),f=e.width,g=e.height,h=d.width,i=d.height,j=h>0?a>=f:f>=a,k=i>0?b>=g:g>=b;if(j&&k){var l=j?f+h:f,m=k?g+i:g;this.setBgSizeTo(l,m),setTimeout(function(){this.setBgSizeByStep(a,b,c,d)}.bind(this),c)}},VisualNovel.prototype.getBgSize=function(){var a=this.screenBgId;return{width:a.width,height:a.height}},VisualNovel.prototype.setBgSizeTo=function(a,b){this.screenBgId.setSize(a,b).setCSS("background-size",a+"px "+b+"px")},VisualNovel.prototype.setBgPosition=function(a,b,c,d){function e(){if(c){var d=f.getBgPosition(),e={x:a,y:b};increment=vector2D(d,e,"x","y");var g=increment.maxDifference/40/(c/1e3);increment.x=increment.x*g,increment.y=increment.y*g,f.setBgPositionByStep(d,e,25,increment)}else f.moveBgPositionBy(a,b)}var f=this;this.eventTracker.addEvent("nowait",e,d)},VisualNovel.prototype.getBgPosition=function(){var a=this.screenBgId,b={x:a.x,y:a.y};return b},VisualNovel.prototype.setBgPositionByStep=function(a,b,c,d){var e=this,f=a.x,g=a.y,h=b.x,i=b.y,j=d.x>0?f>=h:h>=f,k=d.y>0?g>=i:i>=g,l="x"==d.axis?j:k,m=j?0:d.x,n=k?0:d.y;l||(this.moveBgPositionBy(m,n),setTimeout(function(){var a={x:f+m,y:g+n};e.setBgPositionByStep(a,b,c,d)},c))},VisualNovel.prototype.moveBgPositionBy=function(a,b){this.screenBgId.move(a,b,0).update()},VisualNovel.prototype.rotateBg=function(a,b,c,d,e){function f(){g.screenBgId.rotate(a,b,c,d,e),g.screenBgId.update()}var g=this;this.eventTracker.addEvent("nowait",f,0)},VisualNovel.prototype.rotateBgTo=function(a,b,c,d,e){function f(){g.screenBgId.rotateTo(a,b,c,d,e),g.screenBgId.update()}var g=this;this.eventTracker.addEvent("nowait",f,0)},VisualNovel.prototype.stopRotateBg=function(a){function b(){window.clearInterval(c.screenBgId.timer.rotate)}var c=this;this.eventTracker.addEvent("nowait",b,a)},VisualNovel.prototype.fadeBg=function(a,b){function c(){var c=d.screenBgId;"in"===a&&c.fadeIn(b),"out"===a&&c.fadeOut(b)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.resetBg=function(a,b){function c(){"rotate"==a&&(window.clearInterval(d.screenBgId.timer.rotate),d.screenBgId.setRotation(0,0,0).update()),"fade"==a&&d.screenBgId.fadeIn(0)}var d=this;this.eventTracker.addEvent("nowait",c,b)},VisualNovel.prototype.addObjectToScene=function(a,b,c,d,e,f){function g(){var d=b.width,g=b.height,i=h.util.scalePosition({x:c.x,y:c.y,z:c.z},{x:h.sceneFloorWidth,y:-h.sceneFloorHeight,z:h.sceneFloorHeight}),j=ObjectFactory("SceneObject",d,g,i);j.setBackground(d,g,h.imgPath+b.path),e&&j.fadeIn(f),j.name=a,h.sceneFloor.sprite.addChild(j.sprite),h.scenes.object.push(j)}var h=this;this.eventTracker.addEvent("nowait",g,d)},VisualNovel.prototype.moveSceneObject=function(a,b,c,d,e,f){function g(){var f=h.util.getObjectInList(h.scenes.object,"name",a),g=f.obj,i=g.sprite,j=h.util.scalePosition({x:b?b:i.x,y:c?c:i.y,z:d?d:i.z},{x:h.screenWidth,y:h.screenHeight,z:h.screenHeight});g.move(j.x,j.y,j.z,e)}var h=this;this.eventTracker.addEvent("nowait",g,f?f:0)},VisualNovel.prototype.rotateSceneObject=function(a,b,c,d,e){function f(){var f=g.util.getObjectInList(g.scenes.object,"name",a),h=f.obj;h.rotate(b,c,d,e)}var g=this;this.eventTracker.addEvent("nowait",f)},VisualNovel.prototype.fadeSceneObject=function(a,b,c){function d(){var d=e.util.getObjectInList(e.scenes.object,"name",a),f=d.obj,g="string"==typeof b?b.toLowerCase():"";"in"===g&&f.fadeIn(c),"out"===g&&f.fadeOut(c)}var e=this;this.eventTracker.addEvent("nowait",d)},VisualNovel.prototype.resetSceneObject=function(a,b){function c(){var c=d.util.getObjectInList(d.scenes.object,"name",a),e=c.obj,f=e?e.sprite.children[0].timer:null,g=f?f[b]:null;e&&g&&"rotate"==b&&(window.clearInterval(g),g=null)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.removeSceneObject=function(a){function b(){var b=c.util.getObjectInList(c.scenes.object,"name",a),d=b.id;c.sceneFloor.sprite.removeChildAt(d),c.scenes.object.splice(d,1)}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.addTextToScene=function(a,b,c,d){function e(){var d=c.width?c.width:0,e=c.height?c.height:0,g=f.util.scalePosition({x:c.x,y:c.y,z:c.z},{x:f.sceneFloorWidth,y:-f.sceneFloorHeight,z:f.sceneFloorHeight}),h=ObjectFactory("SceneObject",d,e,g);h.sprite.children[0].setInnerHTML(b),c.size&&h.sprite.setCSS("font-size",c.size+"px"),c.color&&h.sprite.setCSS("color",c.color),(c.bgColor||c.bgImage)&&h.setBackground(d,e,c.bgImage?f.imgPath+c.bgImage:null,c.bgColor?c.bgColor:null),c.fade&&h.fadeIn(c.fade),h.name=a,f.sceneFloor.sprite.addChild(h.sprite),f.scenes.object.push(h)}var f=this;this.eventTracker.addEvent("nowait",e,d)},VisualNovel.prototype.fadeSceneText=function(a,b,c){this.fadeSceneObject(a,b,c)},VisualNovel.prototype.removeSceneText=function(a){this.removeSceneObject(a)},VisualNovel.prototype.moveCharacter=function(a,b,c,d){function e(){var e=f.util.getObjectInList(f.characters,"name",a.name),g=e.obj,h=g.sprite,i={x:b?b>1||-1>b?b:b*f.screenWidth:h.x,y:c?c>1||-1>c?c:c*f.screenHeight:h.y};g.move(i.x,i.y,0,d)}var f=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.fadeCharacter=function(a,b,c,d,e){function f(){var f=g.util.getObjectInList(g.characters,"name",a.name),h=f.obj;"in"==b?h.fadeIn(c,d,e):"out"==b&&h.fadeOut(c,d,e)}var g=this;this.eventTracker.addEvent("nowait",f)},VisualNovel.prototype.addCharacter=function(a,b,c){function d(){g.screenCharacterId.style.display="block";var b=a.width/2,c=g.screenHeight-a.height+g.screenHeight*a.pos.y,d=g.screenWidth*a.pos.x,e={x:d,y:c,z:0},f={x:b,y:0,z:0},h=ObjectFactory("Character",a.width,a.height,e,f);return h.setBackground(a.width,a.height,g.imgPath+a.image),h.name=a.name,h}function e(a){g.characterContainer.addChild(a.sprite),g.characters.push(a)}function f(){var a=d();c&&a.fadeIn(b),e(a)}var g=this;this.eventTracker.addEvent("nowait",f,b)},VisualNovel.prototype.removeCharacter=function(a,b,c){function d(){var b=f.util.getObjectInList(f.characters,"name",a.name),c=b.id;f.characterContainer.removeChildAt(c+1),f.characters.splice(c,1)}function e(){if(c){var e=f.util.getObjectInList(f.characters,"name",a.name),g=e.obj;g.fadeOut(b)}f.eventTracker.delayCallback(b,d)}var f=this;this.eventTracker.addEvent("nowait",e,b)},VisualNovel.prototype.removeAllCharacter=function(a){function b(){d.resetCharacters()}function c(){d.eventTracker.delayCallback(a,b)}var d=this;this.eventTracker.addEvent("nowait",c,a)},VisualNovel.prototype.resetCharacters=function(){for(var a=this.characterContainer.children,b=a.length,c=b-1;c>=1;c--)this.characterContainer.removeChildAt(c);this.characters=[]},VisualNovel.prototype.sayLine=function(a,b,c){function d(){var d=e.novelMode;e.setSayDialogDisplay(!0,d),e.buildSayDialog(a,b,c,d),e.updateSayDialogReference(e.novelId),"undefined"==typeof c&&(e.updateSayDialogButtonReference(e.novelId),e.updateDialogButtonPosition(a),e.refreshDialogButtonPositionView(a),e.updateDialogButtonListeners(a))}var e=this;this.eventTracker.addEvent(c?"nowait":"wait",d,c)},VisualNovel.prototype.sayLineExtend=function(a,b){function c(){var b=d.dialogTextId.innerHTML+a;d.dialogTextId.innerHTML=b}var d=this;this.eventTracker.addEvent(b?"nowait":"wait",c,b)},VisualNovel.prototype.sayMultipleLines=function(a,b){var c=b.length,d=[],e=[],f=null;b.forEach(function(a,g){e=[],"string"==typeof a&&(e.push(a),f=g+1,c>f&&"number"==typeof b[f]&&e.push(b[f]),c>f&&"boolean"==typeof b[f]?e.push(0,b[f]):c>f+1&&"boolean"==typeof b[f+1]&&e.push(b[f+1]),d.push(e))}),e=[],d.forEach(function(b){if("boolean"==typeof b[b.length-1])if(0==b[1]){var c=e.join("")+b[0];e=[],this.sayLine(a,c)}else e.push(b[0]),this.sayLineExtend.apply(this,b);else b[1]?e.push(b[0]):e=[],b.unshift(a),this.sayLine.apply(this,b)}.bind(this))},VisualNovel.prototype.say=function(a,b,c){var d=arguments.length,e="object"==typeof a,f="string"==typeof a,g=e||f;g&&"string"==typeof b&&(this.dialogCharacter=a,this.sayLine(a,b,c)),g&&"[object Array]"===Object.prototype.toString.call(b)&&(this.dialogCharacter=a,this.sayMultipleLines(a,b)),f&&(1===d||2===d&&"number"==typeof b)&&this.sayLine(this.dialogCharacter,a,b)},VisualNovel.prototype.buildSayDialog=function(a,b,c,d){var e=d?d:this.novelMode,f="novel"==e?"novelModeId":"dialogModeId",g=this.getSayTemplate(a,b,c);this[f].innerHTML=g},VisualNovel.prototype.getSayTemplate=function(a,b,c){var d=this.getSayTemplateVariables(a,b,c),e=TemplateFactory("say");return e=this.parser.parseTemplate(e,d)},VisualNovel.prototype.getSayTemplateVariables=function(a,b,c){var d="object"==typeof a?a.name:a,e=this.util.replaceVariablesInText(b,this.userInput),f=a.dialog,g=f?!0:!1;if(g)var h=f.image?this.imgPath+f.image:"",i=f.width?f.width+"px":"auto",j=f.height?f.height+"px":"auto",k=f.location?f.location:"",l=k?"left"==k?"margin-right:10px;":"margin-left:10px;":"",m=f.button,n=c?!1:m&&m.image?m.image:!1,o=n?this.imgPath+m.image:"",p=n?m.width+"px":"0px",q=n?m.height+"px":"0px",r=c||n?!1:m&&m.text?m.text:!0,s=m&&m.text?m.text:"OK";else var h="",i="auto",j="auto",k="",l="",r=c?!1:!0,s="OK",n=!1,o="",p="0px",q="0px";var t={novelId:this.novelId,name:d,showDialogImage:g,dialogImage:h,dialogImageWidth:i,dialogImageHeight:j,dialogImageLocation:k,dialogImageBorder:l,dialogLine:e,showButtonText:r,dialogButtonText:s,showButtonImage:n,dialogButtonImage:o,dialogButtonImageWidth:p,dialogButtonImageHeight:q};return t},VisualNovel.prototype.updateSayDialogReference=function(a){this.dialogImageId=document.getElementById(a+"-dialog-dialogImage"),this.dialogTextId=document.getElementById(a+"-dialog-dialogText")},VisualNovel.prototype.updateSayDialogButtonReference=function(a){this.dialogButtonId=document.getElementById(a+"-dialog-dialogButton")},VisualNovel.prototype.setSayDialogDisplay=function(a,b){var c=b?b:this.novelMode,d=a?"block":"none";"dialog"==c&&(this.dialogModeId.style.display=d,this.novelModeId.style.display="none"),"novel"==c&&(this.dialogModeId.style.display="none",this.novelModeId.style.display=d)},VisualNovel.prototype.showSayDialog=function(a){function b(){c.setSayDialogDisplay(a,c.novelMode)}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.input=function(a,b){function c(){d.dialogMenuId.style.display="block",d.buildUserInputContainer(b),d.updateUserInputReference(d.novelId),d.userInputButtonId.onclick=function(){d.getInput(a)}}var d=this;this.eventTracker.addEvent("wait",c)},VisualNovel.prototype.buildUserInputContainer=function(a){var b=this.getUserInputTemplate(a);this.dialogMenuId.innerHTML=b},VisualNovel.prototype.getUserInputTemplate=function(a){var b={novelId:this.novelId,message:a},c=TemplateFactory("userinput");return c=this.parser.parseTemplate(c,b)},VisualNovel.prototype.updateUserInputReference=function(a){this.userInputTextId=document.getElementById(a+"-userInputText"),this.userInputButtonId=document.getElementById(a+"-userInputButton")},VisualNovel.prototype.getInput=function(a){var b=this.userInputTextId;this.userInput[a]=b.value,this.dialogMenuId.style.display="none",this.eventTracker.nextEvent()},VisualNovel.prototype.setValue=function(a,b){function c(){a&&(d.userInput[a]=b)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.resetNovelDialogText=function(){this.novelModeId.innerHTML="",this.dialogModeId.innerHTML=""},VisualNovel.prototype.addCondition=function(a,b,c,d,e){function f(){var f=!1,h=g.userInput;"="==b&&(f=h[a]==c),">"==b&&(f=h[a]>c),"<"==b&&(f=h[a]<c),"!="==b&&(f=h[a]!=c);var i=g.eventTracker,j=i.eventsInProgress.length,k=i.eventsInProgress[j-1]+"-condition-"+j;i.addNewEventInProgress(k),f?d():e(),g.eventTracker.startEvent()}var g=this;this.eventTracker.addEvent("wait",f)},VisualNovel.prototype.choice=function(a,b,c,d){function e(){f.dialogMenuId.style.display="block",f.menuChoices[a]=[];for(var e=b.length,g=0;e>g;g++)f.menuChoices[a].push(b[g]);if(f.buildMenuChoices(b,d),f.updateMenuChoicesReference(f.novelId),f.addMenuChoicesHandler(a,e),c){var h=f.dialogMenuChoiceContainerId.style,i=c.x*f.screenWidth,j=c.y*f.screenHeight;h.left=i+"px",h.top=j+"px"}f.eventTracker.addNewEventInProgress(a)}var f=this;this.eventTracker.addEvent("wait",e)},VisualNovel.prototype.buildMenuChoices=function(a,b){var b=b?b:{image:"",width:0,height:0},c=this.imgPath+b.image,d=this.getMenuChoicesTemplate(a,c,b.width,b.height);this.dialogMenuId.innerHTML=d},VisualNovel.prototype.getMenuChoicesTemplate=function(a,b,c,d){var e={novelId:this.novelId,choices:a,imgPath:b,imgWidth:c,imgHeight:d},f=TemplateFactory("menuchoice",a,b,c,d);return f=this.parser.parseTemplate(f,e)},VisualNovel.prototype.updateMenuChoicesReference=function(){this.dialogMenuChoiceContainerId=document.getElementById(this.novelId+"-dialogMenuChoiceContainer")},VisualNovel.prototype.addMenuChoicesHandler=function(a,b){for(var c=this,d=this.novelId,e=0;b>e;e++)document.getElementById(d+"-dialogMenuChoiceButton"+e).onclick=function(){var b=e;return function(){c.dialogMenuId.style.display="none",c.performMenuChoice(a,b)}}()},VisualNovel.prototype.performMenuChoice=function(a,b){var c=this.menuChoices[a][b];this.menuChoicesTaken[a]=c;var d=c.action;d(),this.resetMenuChoicesForEvent(a),this.eventTracker.startEvent()},VisualNovel.prototype.resetMenuChoicesForEvent=function(a){function b(){c.menuChoices[a]=[]}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.resetMenuChoices=function(){this.menuChoices={},this.menuChoicesTaken={}},EventTracker.prototype.addEvent=function(a,b,c){var d=this.eventsInProgress[this.eventsInProgress.length-1];this.eventList[d].push({type:a,event:b,delay:c?c:0})},EventTracker.prototype.addNewEventInProgress=function(a){this.eventsInProgress.push(a),this.eventList[a]=[],this.eventId[a]=0},EventTracker.prototype.resetEventsInProgress=function(){this.eventId={main:0},this.eventsInProgress=["main"]},EventTracker.prototype.delayCallback=function(a,b){a?setTimeout(function(){b()},a):b()},EventTracker.prototype.startEvent=function(){var a=this,b=$.Deferred(),c=this.eventsInProgress,d=c[c.length-1],e=this.eventList[d],f=this.eventId[d],g=e[f],h=g.type,i=g.delay;g.event(),this.delayCallback(i,function(){b.resolve()}),b.done(function(){"nowait"==h&&a.nextEvent()})},EventTracker.prototype.nextEvent=function(){var a=this.eventsInProgress[this.eventsInProgress.length-1],b=this.eventList[a];this.eventId[a]+=1;var c=this.eventId[a];c<b.length?this.startEvent():1==this.eventsInProgress.length||(this.eventsInProgress.pop(),this.doRepeatEvent?(this.doRepeatEvent=!1,this.startEvent()):this.nextEvent())},Util.prototype.getObjectInList=function(a,b,c){for(var d={id:null,obj:null},e=a?a:[],f=e.length,g=f-1;g>=0;g--)e[g][b]==c&&(d.id=g,d.obj=e[g]);return d},Util.prototype.scalePosition=function(a,b){var c={x:a.x>1||a.x<-1?a.x:a.x*b.x,y:a.y>1||a.y<-1?a.y:a.y*b.y,z:a.z>1||a.z<-1?a.z:a.z*b.z};return c},Util.prototype.foreach=function(a,b,c){var d=a.length,e=null;for(e=0;d>e;e++)c?b.call(c,a[e],e):b(a[e],e)},Util.prototype.replaceVariablesInText=function(a,b){var c=a+"",d="",e="",f=null;for(d in b)e=b[d],f=new RegExp("{"+d+"}","gi"),c=c.replace(f,e);return c},Parser.prototype=Object.create(Util.prototype),Parser.prototype.constructor=Parser,Parser.prototype.parseTemplate=function(a,b){return a=this.parseConditionsInTemplate(a,b),a=this.replaceVariablesInText(a,b),a=this.parseLoopsInTemplate(a,b)},Parser.prototype.parseConditionsInTemplate=function(a,b){var c=a.slice(),d=[],e=c.split(/(<\s*if\s*[^>]*>(.|\n)*?<\s*\/\s*if>)/i);
return e.forEach(function(a){""!=a&&">"!=a&&d.push(a)}),d&&d.length>1&&this.foreach(d,function(a,c){var e=a.replace(/<if={(.*)}>.*<\/if>/i,"$1"),f=b[e],g=void 0===f?e:f?a.replace(/<if={.*}>(.*)<\/if>/i,"$1"):"";d[c]=g.slice()},this),c=d.join("")},Parser.prototype.parseLoopsInTemplate=function(a,b){var c=a.slice(),d=c.match(/<foreach={.*}>.*<\/foreach>/gi);if(d&&d.length>0){var e=[];this.foreach(d,function(a){var c=[],d=a.replace(/<foreach={.*}>(.*)<\/foreach>/gi,"$1"),f=a.replace(/<foreach={(.*)}>.*<\/foreach>/gi,"$1");f=f.split(" ");var g=f[2],h=f[0];this.foreach(b[g],function(a,b){var e=d.replace(/{index}/gi,b),f=new RegExp("{"+h+".(.*)}","gi");e=e.replace(f,"{$1}"),e=this.replaceVariablesInText(e,a),c.push(e)},this),e.push(c.join(""))},this),this.foreach(e,function(a){c=c.replace(/<foreach={.*}>.*<\/foreach>/i,a)})}return c},Effect.prototype.perform=function(a,b,c,d,e){null==b.timer&&(b.timer={}),this[a]&&this[a](b,c,d,e)},Effect.prototype.fadeIn=function(a,b,c,d){var e=d&&d.step?d.step:1,f=d&&"undefined"!=typeof d.from&&d.from>=0?d.from:0,g=d&&"undefined"!=typeof d.to&&d.to>=0?d.to:100;this.fade(a,c,f,g,e)},Effect.prototype.fadeOut=function(a,b,c,d){var e=d&&d.step?d.step:-1,f=d&&"undefined"!=typeof d.from&&d.from>=0?d.from:100,g=d&&"undefined"!=typeof d.to&&d.to>=0?d.to:0;this.fade(a,c,f,g,e)},Effect.prototype.fade=function(a,b,c,d,e){var f=this,g=0>e?-1:1,h=c+g,i=0>e?h>=d&&c>=h:h>=c&&d>=h;i&&(a.setOpacity(h/100),a.timer.fade=setTimeout(function(){f.fade(a,b,h,d,e)},b/100))},Effect.prototype.move=function(a,b,c,d){var e=this,f=d.x,g=d.y,h=d.z,i={x:f?f>1||-1>f?f:f*e.screenWidth:a.x,y:g?g>1||-1>g?g:g*e.screenHeight:a.y,z:h?h>1||-1>h?h:h*e.screenHeight:a.x},j={x:f?Math.abs(i.x-a.x):0,y:g?Math.abs(i.y-a.y):0,z:h?Math.abs(i.z-a.z):0};if(null==a.moveStep){var k={x:f?a.x<i.x?j.x/100:-j.x/100:0,y:g?a.y<i.y?j.y/100:-j.y/100:0,z:h?a.z<i.z?j.z/100:-j.z/100:0};k.x=f?a.x==i.x?0:Math.round(k.x):0,k.y=g?a.y==i.y?0:Math.round(k.y):0,k.z=h?a.z==i.z?0:Math.round(k.z):0,a.moveStep=k}var l=a.moveStep,m=l.x>0?a.x<i.x:a.x>i.x,n=l.y>0?a.y<i.y:a.y>i.y,o=l.z>0?a.z<i.z:a.z>i.z;m||n||o?(a.x=f?a.x+l.x:a.x,a.y=g?a.y+l.y:a.y,a.z=h?a.z+l.z:a.z,a.update(),a.timer.move=setTimeout(function(){e.move(a,b,c,d)},c/100)):a.moveStep=null},Effect.prototype.rotate=function(a,b,c,d){var e=d.axis,f=d.angle,g=a,h=null;"y"==e&&(h=function(){g.rotateY(f)}),"z"==e&&(h=function(){g.rotateZ(f)}),a.timer.rotate=c>=0?setTimeout(function(){h(),g.update()},c):setInterval(function(){h(),g.update()},-c)},Sprite.prototype.init=function(a,b,c,d,e){var f=this.createSprite(a,b,c,d,e);this.sprite=f},Sprite.prototype.createSprite=function(a,b,c,d,e){var f=c,g=d,h=(new Sprite3D).setClassName("sprite").setSize(a,b).setTransformOrigin(g.x,g.y,g.z).setPosition(f.x,f.y,f.z).rotateX(e&&e.x?e.x:0).rotateY(e&&e.y?e.y:0).rotateZ(e&&e.z?e.z:0).setRotateFirst(!0).update();return h.setCSS("-webkit-transform-origin",g.x+"px "+g.y+"px"),h.timer={},h},Sprite.prototype.setBackground=function(a,b,c,d){a&&b&&this.sprite.setCSS("background-size",a+"px "+b+"px"),c&&this.sprite.setCSS("background-image","url('"+c+"')"),d&&this.sprite.setCSS("background-color",d)},Sprite.prototype.move=function(a,b,c,d){var e=this,f=this.sprite,g={x:a?a:f.x,y:b?b:f.y,z:c?c:f.x},h={x:a?Math.abs(g.x-f.x):0,y:b?Math.abs(g.y-f.y):0,z:c?Math.abs(g.z-f.z):0};if(null==f.moveStep){var i={x:a?f.x<g.x?h.x/100:-h.x/100:0,y:b?f.y<g.y?h.y/100:-h.y/100:0,z:c?f.z<g.z?h.z/100:-h.z/100:0};i.x=a?f.x==g.x?0:Math.round(i.x):0,i.y=b?f.y==g.y?0:Math.round(i.y):0,i.z=c?f.z==g.z?0:Math.round(i.z):0,f.moveStep=i}var j=f.moveStep,k=j.x>0?f.x<g.x:f.x>g.x,l=j.y>0?f.y<g.y:f.y>g.y,m=j.z>0?f.z<g.z:f.z>g.z;k||l||m?(f.x=a?f.x+j.x:f.x,f.y=b?f.y+j.y:f.y,f.z=c?f.z+j.z:f.z,f.update(),f.timer.move=setTimeout(function(){e.move(a,b,c,d)},d/100)):f.moveStep=null},Sprite.prototype.rotate=function(a,b,c,d,e){var f=e?e:this.sprite,g=function(){},h=c?c:0;a&&(g=function(){f["rotate"+a.toUpperCase()](b)}),f.timer.rotate=d?setInterval(function(){g(),f.update()},h):setTimeout(function(){g(),f.update()},h)},Sprite.prototype.rotateTo=function(a,b,c,d){var e=this,f=d?d:this.sprite,g=a.toUpperCase(),h=f["rotation"+g];if(h!=b){var i=b>=0?1:-1,j=function(){f["setRotation"+g](h+i).update()};f.timer.rotate=setTimeout(function(){j(),e.rotateTo(a,b,c,d)},c?c:0)}else f.timer.rotate=null},Sprite.prototype.fade=function(a,b,c,d){var e=this,f=this.sprite,g=0>c?-1:1,h=a+g,i=0>c?h>=b&&a>=h:h>=a&&b>=h;i&&(f.setOpacity(h/100),f.timer.fade=setTimeout(function(){e.fade(h,b,c,d)},d/100))},Sprite.prototype.fadeIn=function(a,b,c){var d=1,e=b&&b>0?b:0,f=c&&c>0?c:100;this.fade(e,f,d,a)},Sprite.prototype.fadeOut=function(a,b,c){var d=-1,e=b&&b>0?b:100,f=c&&c>0?c:0;this.fade(e,f,d,a)},Character.prototype=Object.create(Sprite.prototype),Character.prototype.constructor=Character,SceneObject.prototype=Object.create(Sprite.prototype),SceneObject.prototype.constructor=SceneObject,SceneObject.prototype.init=function(a,b,c){var d={x:c.x-25,y:c.z,z:c.y},e={x:c.x+a/2,y:0},f=this.createSprite(50,50,d,e);d={x:-(a/2)+25,y:-b,z:0},e={x:25,y:0,z:0};var g={x:110,y:0,z:0},h=this.createSprite(a,b,d,e,g);h.update(),f.addChild(h),this.sprite=f},SceneObject.prototype.setBackground=function(a,b,c,d){var e=this.sprite.children[0];a&&b&&e.setCSS("background-size",a+"px "+b+"px"),c&&e.setCSS("background-image","url('"+c+"')"),d&&e.setCSS("background-color",d)},SceneObject.prototype.rotate=function(a,b,c,d){var e=this.sprite.children[0];Sprite.prototype.rotate.call(this,a,b,c,d,e)};