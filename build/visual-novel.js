function VisualNovel(t,e,i,o){return this instanceof VisualNovel?(this.novelId=t,this.novelTitle="",this.novelSubtitle="",this.novelMode="dialog",this.imgPath=o?o:"",this.images=[],this.novelContainerId=null,this.screenStartId=null,this.screenStartMenuButtonContainerId=null,this.screenStartMenuStartButtonId=null,this.novelModeId=null,this.dialogModeId=null,this.dialogButtonId=null,this.dialogImageId=null,this.dialogTextId=null,this.dialogMenuId=null,this.screenCharacterId=null,this.screenSceneId=null,this.screenBgId=null,this.preLoadedImagesId=null,this.defaultVal={},this.timers={},this.sceneContainer=null,this.sceneFloor=null,this.scenes={text:[],object:[]},this.characterContainer=null,this.characters=[],this.menuChoicesTaken={},this.menuChoices={},this.userInput={},this.screenWidth=e,this.screenHeight=i,this.dialogWidth=e,this.dialogHeight=150,this.dialogPadding={top:10,right:10,bottom:10,left:10},this.dialogBorder={top:10,right:50,bottom:10,left:50},this.dialogTextColor="white",this.dialogBgColor="rgba(0,0,0,0.5)",this.dialogButtonSize={width:40,height:30},this.dialogButtonPos={left:e-this.dialogPadding.right-this.dialogButtonSize.width,bottom:0},this.dialogCharacter=null,this.sceneHeight=this.screenHeight-this.dialogHeight,this.sceneFloorHeight=i>e?i:e,this.sceneFloorWidth=i>e?i:e,this.templates={novelcontainer:["<div class='novel-container unSelectable'>","<div id='{novelId}-screen-start' class='novel screen-start'></div>","<div id='{novelId}-dialog-menu' class='novel dialog-menu'></div>","<div id='{novelId}-dialog-novelmode' class='novel dialog-novelmode'></div>","<div id='{novelId}-dialog-dialogmode' class='novel dialog-dialogmode'></div>","<div id='{novelId}-screen-character' class='novel screen-character'></div>","<div id='{novelId}-screen-scene' class='novel screen-scene'></div>","<div id='{novelId}-screen-bg' class='novel screen-bg'></div>","<div id='{novelId}-images' style='display:none;'></div>","</div>"],startmenu:["<div id='{novelId}-novelTitleContainer' class='novelTitleContainer'>","<div id='{novelId}-novelTitleText' class='novelTitleText'>{novelTitle}</div>","<div id='{novelId}-novelSubtitleText' class='novelSubtitleText'>{novelSubtitle}</div>","</div>","<div id='{novelId}-startMenuButtonContainer' class='startMenuButtonContainer'>","<button id='{novelId}-startMenuButton' class='startMenuButton' >","START</button>","</div>"],say:["<if={showDialogImage}><img id='{novelId}-dialog-dialogImage' src='{dialogImage}' style='{dialogImageStyle}' /></if>","<div id='{novelId}-dialog-dialogName' class='dialogName' style='{dialogNameStyle}'>{name}</div>","<div id='{novelId}-dialog-dialogText' class='dialogText'>{dialogLine}</div>","<if={showButtonText}><button id='{novelId}-dialog-dialogButton' class='dialogButton' >{dialogButtonText}</button></if>","<if={showButtonImage}><img id='{novelId}-dialog-dialogButton' class='dialogButton' src='{dialogButtonImage}' style='{dialogButtonImageStyle}' /></if>"],userinput:["<div id='userInputContainer' class='userInputContainer'>","<div id='userInputMessage' class='userInputMessage'>{message}</div><hr/><br/>","<input id='{novelId}-userInputText' class='userInputText' type='text' /><br/><br/>","<input type='button' id='{novelId}-userInputButton' class='userInputButton' value='OK' />","</div>"],menuchoice:["<div id='{novelId}-dialogMenuChoiceContainer' class='dialogMenuChoiceContainer'>","<div id='{novelId}-dialogMenuChoiceButtonsContainer' class='dialogMenuChoiceButtonsContainer'>","<foreach={choice in choices}>","<button class='dialogMenuChoiceButton' id='{novelId}-dialogMenuChoiceButton{index}' >","{choice.label}","</button><br/>","</foreach>","</div>","<div id='{novelId}-dialogMenuChoiceImageContainer' class='dialogMenuChoiceImageContainer'>","<if={imgPath}><img src='{imgPath}' style='width:{imgWidth}px;height:{imgHeight}px;' /></if>","</div>","</div>"]},this):new VisualNovel(e,i,o)}function EventTracker(){var t=null;return this instanceof EventTracker?(this.doRepeatEvent=!1,this.eventsInProgress=["main"],this.eventList={main:[]},this.eventId={main:0},this.save={eventsInProgress:[],eventId:{}},t=this):t=new EventTracker,t}function Util(){var t=null;return t=this instanceof Util?this:new Util}function vector2D(t,e,i,o){var n=t[i],a=t[o],r=e[i],s=e[o],l=Math.abs(r-n),c=Math.abs(s-a),u=r>n?1:-1,h=s>a?1:-1,d=c,p=o.slice(),v=u*(l/c),g=h;l>c&&(d=l,p=i.slice(),v=u,g=h*(c/l));var f={axis:p,maxDifference:d};return f[i]=v,f[o]=g,f}function Parser(){var t=null;return this instanceof Parser?(Util.apply(this,arguments),t=this):t=new Parser,t}function ObjectFactory(t){var e=null;if("SceneObject"===t&&(e=SceneObject.apply({},[].slice.call(arguments,1))),"Character"===t&&(e=Character.apply({},[].slice.call(arguments,1))),"SpriteContainer"===t&&(e=new Sprite3D(arguments[1]),e.addChild(Sprite3D.createCenteredContainer())),"ScreenBg"===t&&(e=new Sprite3D(arguments[1]),e.addChild(Sprite3D.createCenteredContainer()),e.sprite=e,e.timer={},e.rotate=Sprite.prototype.rotate,e.rotateTo=Sprite.prototype.rotateTo,e.fade=Sprite.prototype.fade,e.fadeIn=Sprite.prototype.fadeIn,e.fadeOut=Sprite.prototype.fadeOut),"SceneFloor"===t){var i=arguments[1],o=arguments[2],n={x:-(i/2),y:-(o/2),z:-50},a={x:0,y:0},r={x:-90,y:0,z:0};e=new Sprite(i,o,n,a,r)}return"SceneFloorContainer"===t&&(e=(new Sprite3D).setClassName("sceneFloorContainer").setZ(0).rotateX(-20).update()),e}function TemplateFactory(t){var e=null;return this instanceof TemplateFactory?(this.templates=t?t:{},e=this):e=new TemplateFactory(t),e}function Effect(t,e){return this instanceof Effect?(this.screenWidth=t,this.screenHeight=e,this):new Effect}function Sprite(t,e,i,o,n){return this instanceof Sprite?(this.sprite=null,this.init(t,e,i,o,n),this):new Sprite(t,e,i,o,n)}function Character(t,e,i,o,n){return this instanceof Character?(Sprite.apply(this,arguments),this.init(t,e,i,o,n),this):new Character(t,e,i,o,n)}function SceneObject(t,e,i,o,n){return this instanceof SceneObject?(Sprite.apply(this,arguments),this.init(t,e,i,o,n),this):new SceneObject(t,e,i,o,n)}VisualNovel.prototype.init=function(t){var e="undefined"==typeof t?this.novelId:t;this.initObjects(),this.initContainers(e),this.initScreenStart(e)},VisualNovel.prototype.initObjects=function(){this.util=new Util,this.parser=new Parser,this.eventTracker=new EventTracker,this.templates=new TemplateFactory(this.templates)},VisualNovel.prototype.initContainers=function(t){this.initNovelContainer(t),this.initSceneContainer(),this.initDialogMenuContainer(),this.initNovelModeContainer(),this.initDialogModeContainer(),this.initCharacterContainer(),this.initBGContainer()},VisualNovel.prototype.pause=function(t){function e(){setTimeout(function(){i.eventTracker.nextEvent()},t)}var i=this;this.eventTracker.addEvent("wait",e)},VisualNovel.prototype.repeatEvent=function(){function t(){e.eventTracker.doRepeatEvent=!0}var e=this;this.eventTracker.addEvent("nowait",t)},VisualNovel.prototype.reset=function(){function t(){e.resetNovel(),e.showStartScreen(!0)}var e=this;this.eventTracker.addEvent("wait",t)},VisualNovel.prototype.resetNovel=function(){this.eventTracker.resetEventsInProgress(),this.resetMenuChoices(),this.resetCharacters(),this.resetScenes(),this.resetLoops()},VisualNovel.prototype.setNovelTitle=function(t,e){this.updateNovelTitleModel(t,e),this.updateNovelTitleView(t,e)},VisualNovel.prototype.updateNovelTitleModel=function(t,e){this.novelTitle=t,this.novelSubtitle=e},VisualNovel.prototype.updateNovelTitleView=function(t,e){this.novelTitleTextId.innerHTML=t,this.novelSubtitleTextId.innerHTML=e},VisualNovel.prototype.setNovelTitlePosition=function(t,e){var i=this.util.scalePosition({x:t,y:e},{x:this.screenWidth,y:this.screenHeight}),o=";left:"+i.x+"px;top:"+i.y+"px;";this.novelTitleContainerId.style.cssText+=o},VisualNovel.prototype.setNovelMode=function(t,e,i,o,n){function a(){r.novelMode=t?t:"dialog",s&&(r.setDialogModeContainerSize(e,i),r.setDialogButtonPosition(e-r.dialogPadding.right-r.dialogButtonSize.width)),l&&r.setDialogModeContainerPosition(o,n)}var r=this,s="undefined"!=typeof e&&"undefined"!=typeof i,l="undefined"!=typeof o&&"undefined"!=typeof n;this.eventTracker.addEvent("nowait",a)},VisualNovel.prototype.initNovelContainer=function(t){this.novelContainerId=document.getElementById(t);var e=this.buildNovelContainerContent(t);this.setNovelContainerContent(e),this.updateNovelContainerReference(t),this.setNovelContainerSize(this.screenWidth,this.screenHeight)},VisualNovel.prototype.buildNovelContainerContent=function(t){var e=this.templates.get("novelcontainer");return e=this.parser.parseTemplate(e,{novelId:t})},VisualNovel.prototype.setNovelContainerContent=function(t){this.novelContainerId.innerHTML=t},VisualNovel.prototype.updateNovelContainerReference=function(t){var e=document;this.screenStartId=e.getElementById(t+"-screen-start"),this.novelModeId=e.getElementById(t+"-dialog-novelmode"),this.dialogModeId=e.getElementById(t+"-dialog-dialogmode"),this.dialogMenuId=e.getElementById(t+"-dialog-menu"),this.screenCharacterId=e.getElementById(t+"-screen-character"),this.screenSceneId=e.getElementById(t+"-screen-scene"),this.screenBgId=e.getElementById(t+"-screen-bg")},VisualNovel.prototype.setNovelContainerSize=function(t,e){var i=this.novelContainerId,o=i?i.getElementsByClassName("novel"):[],n=";overflow:hidden;width:"+t+"px;height:"+e+"px;";i.style.cssText+=n,this.util.foreach(o,function(i){n=";width:"+t+"px;height:"+e+"px;",i.style.cssText+=n})},VisualNovel.prototype.initScreenStart=function(t){this.buildStartMenu(t),this.updateStartMenuReference(t),this.showStartScreen(!0),this.addStartMenuButtonHandler()},VisualNovel.prototype.addStartMenuButtonHandler=function(){var t=this;this.screenStartMenuStartButtonId.onclick=function(){t.startNovel()}},VisualNovel.prototype.startNovel=function(){this.showStartScreen(!1),this.eventTracker.startEvent()},VisualNovel.prototype.buildStartMenu=function(t){var e=this.screenStartId,i=this.templates.get("startmenu"),o={novelId:t,novelTitle:this.novelTitle,novelSubtitle:this.novelSubtitle};i=this.parser.parseTemplate(i,o),e.innerHTML=i},VisualNovel.prototype.updateStartMenuReference=function(t){var e=document;this.novelTitleContainerId=e.getElementById(t+"-novelTitleContainer"),this.novelTitleTextId=e.getElementById(t+"-novelTitleText"),this.novelSubtitleTextId=e.getElementById(t+"-novelSubtitleText"),this.screenStartMenuButtonContainerId=e.getElementById(t+"-startMenuButtonContainer"),this.screenStartMenuStartButtonId=e.getElementById(t+"-startMenuButton"),this.preLoadedImagesId=e.getElementById(t+"-images")},VisualNovel.prototype.showStartScreen=function(t){var e=t?"block":"none";this.screenStartId.style.display=e},VisualNovel.prototype.setStartScreenBgImage=function(t,e,i){var o=this.imgPath+t,n=";background-image:url('"+o+"');background-size:"+e+"px "+i+"px;";this.storeImage(o),this.screenStartId.style.cssText+=n},VisualNovel.prototype.setStartScreenBgColor=function(t){this.screenStartId.style["background-color"]=t},VisualNovel.prototype.setStartScreenMenuBgImage=function(t,e,i){var o=";background-image:url('"+this.imgPath+t+"');background-size:"+e+"px "+i+"px;";this.screenStartMenuButtonContainerId.style.cssText+=o},VisualNovel.prototype.setStartScreenMenuBgColor=function(t){this.screenStartMenuButtonContainerId.style["background-color"]=t},VisualNovel.prototype.setStartScreenMenuPos=function(t,e){var i=t>1?t:t*this.screenHeight,o=e>1?e:e*this.screenWidth,n=";left:"+i+"px;top:"+o+"px;";this.screenStartMenuButtonContainerId.style.cssText+=n},VisualNovel.prototype.initSceneContainer=function(){var t=this.createSceneContainer(this.screenSceneId,this.sceneFloorWidth,this.sceneFloorHeight);this.sceneContainer=t.floorContainer,this.sceneFloor=t.floor},VisualNovel.prototype.createSceneContainer=function(t,e,i){var o=ObjectFactory("SpriteContainer",t),n=o.children[0],a=ObjectFactory("SceneFloor",e,i),r=ObjectFactory("SceneFloorContainer");r.addChild(a.sprite),n.addChild(r);var s={floorContainer:r,floor:a};return s},VisualNovel.prototype.rotateScene=function(t,e,i,o){function n(){a.sceneFloor.rotate(t,e,i,o)}var a=this;this.eventTracker.addEvent("nowait",n)},VisualNovel.prototype.moveScene=function(t,e,i,o){function n(){a.sceneFloor.move(t,e,i,o)}var a=this;this.eventTracker.addEvent("nowait",n)},VisualNovel.prototype.resetScenes=function(){var t=this.sceneContainer.children,e=t.length;if(e>1)for(var i=e-1;i--;)this.sceneContainer.removeChildAt(i+1);this.scenes={text:[],object:[]}},VisualNovel.prototype.initDialogMenuContainer=function(){this.dialogMenuId.style.display="none"},VisualNovel.prototype.initNovelModeContainer=function(){this.novelModeId.style.display="none"},VisualNovel.prototype.initDialogModeContainer=function(){this.setSayDialogDisplay(!1),this.setDialogModeContainerSize(this.dialogWidth,this.dialogHeight),this.setDialogModeContainerPosition(0,this.sceneHeight),this.setDialogTextColor(this.dialogTextColor),this.setDialogBgColor(this.dialogBgColor)},VisualNovel.prototype.setDialogModeContainerSize=function(t,e){var i=this.calculateDialogModeContainerSize(t,e),o=";width:"+i.width+";height:"+i.height+";";this.dialogModeId.style.cssText+=o,this.dialogWidth=t,this.dialogHeight=e},VisualNovel.prototype.calculateDialogModeContainerSize=function(t,e){var i=this.dialogPadding,o=t?t:this.dialogWidth,n=e?e:this.dialogHeight,a={width:o-i.left-i.right+"px",height:n-i.top-i.bottom+"px"};return a},VisualNovel.prototype.setDialogModeContainerPosition=function(t,e){var i=this.util.scalePosition({x:t?t:0,y:e?e:this.sceneHeight},{x:this.screenWidth,y:this.screenHeight}),o=";left:"+i.x+"px;top:"+i.y+"px;";this.dialogModeId.style.cssText+=o},VisualNovel.prototype.setDialogBgImage=function(t,e,i){var o=t?";background-image:url('"+this.imgPath+t+"');":";",n=e&&i?"width:"+e+"px;height: "+i+"px;":"",a=o+n;this.dialogModeId.style.cssText+=a},VisualNovel.prototype.setDialogBgColor=function(t){this.dialogModeId.style["background-color"]=t?t:"black"},VisualNovel.prototype.setDialogTextColor=function(t){this.dialogModeId.style.color=t?t:"white"},VisualNovel.prototype.setDialogBorderStyle=function(t,e,i,o){var n=(this.dialogPadding,t?"url('"+this.imgPath+t+"')":"",i?"string"==typeof i?i:i+"px":"");n=""===n?";":";border-width:"+n+";";var a="border-style:solid;",r=e?e:"rgba( 0, 0, 0, 0.5 )";r="border-color:"+r+";";var s=o?"string"==typeof o?o:o+"px":"";s=""===s?"":"border-radius:"+s+";";var l=n+a+r+s;this.dialogModeId.style.cssText+=l,this.setDialogModeContainerSize(this.dialogWidth,this.dialogHeight)},VisualNovel.prototype.setDialogButtonPosition=function(t,e){var i=this.dialogButtonPos;"undefined"!=typeof t&&(i.left=t),"undefined"!=typeof e&&(i.bottom=e)},VisualNovel.prototype.updateDialogButtonPosition=function(t){var e="object"==typeof t?!0:!1,i=e&&t.dialog&&t.dialog.button?t.dialog.button:null,o=i&&i.width;if(o){var n=this.dialogPadding;this.setDialogButtonPosition(this.dialogWidth-n.right-n.left-i.width)}},VisualNovel.prototype.refreshDialogButtonPositionView=function(){var t=this.dialogButtonPos,e=";left:"+t.left+"px;bottom:"+t.bottom+"px;";this.dialogButtonId.style.cssText+=e},VisualNovel.prototype.updateDialogButtonListeners=function(t){var e=this,i="object"==typeof t?!0:!1,o=i&&t.dialog?t.dialog:null,n=o&&t.dialog.button?t.dialog.button:null,a=this.dialogButtonId,r=this.dialogImageId,s=n&&n.bgColor&&n.bgColorHover,l=n&&n.bgColorHover?n.bgColorHover:"transparent",c=s?function(){a.style["background-color"]=l}:function(){},u=n&&n.bgColor?n.bgColor:"transparent",h=s?function(){a.style["background-color"]=u}:function(){},d=n&&n.image&&n.imageHover,p=n&&n.imageHover?this.imgPath+n.imageHover:"",v=d?function(){a.setAttribute("src",p)}:function(){},g=n&&n.image?this.imgPath+n.image:"",f=d?function(){a.setAttribute("src",g)}:function(){};a.onmouseover=function(){c(),v()},a.onmouseleave=function(){h(),f()};var y=function(){},m=null,I=o&&o.image?this.imgPath+o.image:"",S=o&&o.nextImage?this.imgPath+o.nextImage:"",C=o&&o.imageDelay?o.imageDelay:5e3;o&&o.nextImage&&(m=setInterval(function(){r.setAttribute("src",S),setTimeout(function(){r.setAttribute("src",I)},200)},C),y=function(){window.clearInterval(m)}),this.dialogButtonId.onclick=function(){e.eventTracker.nextEvent(),y()}},VisualNovel.prototype.initCharacterContainer=function(){var t=this.screenCharacterId,e=";display:none;width:"+this.screenWidth+"px;height:"+this.screenHeight+"px;";t.style.cssText+=e,this.characterContainer=ObjectFactory("SpriteContainer",t)},VisualNovel.prototype.initBGContainer=function(){this.screenBgId=ObjectFactory("ScreenBg",this.screenBgId)},VisualNovel.prototype.setBgImage=function(t,e,i,o,n,a){function r(){var o=s.screenBgId;o.setPosition(0,0,0).setSize(e,i).setCSS("background-image","url('"+s.imgPath+t+"')"),n&&a&&o.setCSS("background-size",n+"px "+a+"px"),o.update()}var s=this;this.eventTracker.addEvent("nowait",r)},VisualNovel.prototype.setBgColor=function(t){function e(){i.screenBgId.style["background-color"]=t}var i=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.setBgSize=function(t,e,i,o){function n(){if(i){var o=vector2D(a.getBgSize(),{width:t,height:e},"width","height"),n=o.maxDifference/40/(i/1e3);o.width=o.width*n,o.height=o.height*n,a.setBgSizeByStep(t,e,25,o)}else a.setBgSizeTo(t,e);a.screenBgId.update()}var a=this;this.eventTracker.addEvent("nowait",n,o)},VisualNovel.prototype.setBgSizeByStep=function(t,e,i,o){var n=this.getBgSize(),a=n.width,r=n.height,s=o.width,l=o.height,c=s>0?t>=a:a>=t,u=l>0?e>=r:r>=e;if(c&&u){var h=c?a+s:a,d=u?r+l:r;this.setBgSizeTo(h,d),setTimeout(function(){this.setBgSizeByStep(t,e,i,o)}.bind(this),i)}},VisualNovel.prototype.getBgSize=function(){var t=this.screenBgId;return{width:t.width,height:t.height}},VisualNovel.prototype.setBgSizeTo=function(t,e){this.screenBgId.setSize(t,e).setCSS("background-size",t+"px "+e+"px")},VisualNovel.prototype.setBgPosition=function(t,e,i,o){function n(){if(i){var o=a.getBgPosition(),n={x:t,y:e};increment=vector2D(o,n,"x","y");var r=increment.maxDifference/40/(i/1e3);increment.x=increment.x*r,increment.y=increment.y*r,a.setBgPositionByStep(o,n,25,increment)}else a.moveBgPositionBy(t,e)}var a=this;this.eventTracker.addEvent("nowait",n,o)},VisualNovel.prototype.getBgPosition=function(){var t=this.screenBgId,e={x:t.x,y:t.y};return e},VisualNovel.prototype.setBgPositionByStep=function(t,e,i,o){var n=this,a=t.x,r=t.y,s=e.x,l=e.y,c=o.x>0?a>=s:s>=a,u=o.y>0?r>=l:l>=r,h="x"==o.axis?c:u,d=c?0:o.x,p=u?0:o.y;h||(this.moveBgPositionBy(d,p),setTimeout(function(){var t={x:a+d,y:r+p};n.setBgPositionByStep(t,e,i,o)},i))},VisualNovel.prototype.moveBgPositionBy=function(t,e){this.screenBgId.move(t,e,0).update()},VisualNovel.prototype.rotateBg=function(t,e,i,o,n){function a(){r.screenBgId.rotate(t,e,i,o,n),r.screenBgId.update()}var r=this;this.eventTracker.addEvent("nowait",a,0)},VisualNovel.prototype.rotateBgTo=function(t,e,i,o,n){function a(){r.screenBgId.rotateTo(t,e,i,o,n),r.screenBgId.update()}var r=this;this.eventTracker.addEvent("nowait",a,0)},VisualNovel.prototype.stopRotateBg=function(t){function e(){window.clearInterval(i.screenBgId.timer.rotate)}var i=this;this.eventTracker.addEvent("nowait",e,t)},VisualNovel.prototype.fadeBg=function(t,e){function i(){var i=o.screenBgId;"in"===t&&i.fadeIn(e),"out"===t&&i.fadeOut(e)}var o=this;this.eventTracker.addEvent("nowait",i)},VisualNovel.prototype.resetBg=function(t,e){function i(){var e=o.screenBgId;"rotate"==t&&(window.clearInterval(e.timer.rotate),e.setRotation(0,0,0).update()),"fade"==t&&e.fadeIn(0)}var o=this;this.eventTracker.addEvent("nowait",i,e)},VisualNovel.prototype.addObjectToScene=function(t,e,i,o,n,a){function r(){var o=e.width,r=e.height,l=s.util.scalePosition({x:i.x,y:i.y,z:i.z},{x:s.sceneFloorWidth,y:-s.sceneFloorHeight,z:s.sceneFloorHeight}),c=ObjectFactory("SceneObject",o,r,l);c.setBackground(o,r,e.path?s.imgPath+e.path:"",e.color),n&&c.fadeIn(a),c.name=t,s.sceneFloor.sprite.addChild(c.sprite),s.scenes.object.push(c)}var s=this;this.eventTracker.addEvent("nowait",r,o)},VisualNovel.prototype.moveSceneObject=function(t,e,i,o,n,a){function r(){s.setSceneObjectPosition(t,e,i,o,n)}var s=this;this.eventTracker.addEvent("nowait",r,a?a:0)},VisualNovel.prototype.setSceneObjectPosition=function(t,e,i,o,n){var a=this.util,r=a.getObjectInList(this.scenes.object,"name",t),s=r.obj,l=s.sprite,c=a.scalePosition({x:e?e:l.x,y:i?i:l.y,z:o?o:l.z},{x:this.screenWidth,y:this.screenHeight,z:this.screenHeight});n?s.move(c.x,c.y,c.z,n):s.moveTo(c.x,c.y,c.z)},VisualNovel.prototype.rotateSceneObject=function(t,e,i,o,n){function a(){r.setSceneObjectRotation(t,e,i,o,n)}var r=this;this.eventTracker.addEvent("nowait",a)},VisualNovel.prototype.setSceneObjectRotation=function(t,e,i,o,n){var a=this.util.getObjectInList(this.scenes.object,"name",t),r=a.obj;n?r.rotate(e,i,o,n):r.rotateTo(e,i,o)},VisualNovel.prototype.fadeSceneObject=function(t,e,i){function o(){n.setSceneObjectFade(t,e,i)}var n=this;this.eventTracker.addEvent("nowait",o)},VisualNovel.prototype.setSceneObjectFade=function(t,e,i){var o=this.util.getObjectInList(this.scenes.object,"name",t),n=o.obj,a="string"==typeof e?e.toLowerCase():"";"in"===a&&n.fadeIn(i),"out"===a&&n.fadeOut(i)},VisualNovel.prototype.setSceneObjectStyle=function(t,e){var i=this.util.getObjectInList(this.scenes.object,"name",t),o=i.obj;o.sprite.children[0].style.cssText+=e},VisualNovel.prototype.resetSceneObject=function(t,e){function i(){var i=o.util.getObjectInList(o.scenes.object,"name",t),n=i.obj,a=n?n.sprite.children[0].timer:null,r=a?a[e]:null;n&&r&&"rotate"==e&&(window.clearInterval(r),r=null)}var o=this;this.eventTracker.addEvent("nowait",i)},VisualNovel.prototype.removeSceneObject=function(t){function e(){var e=i.util.getObjectInList(i.scenes.object,"name",t),o=e.id;i.sceneFloor.sprite.removeChildAt(o),i.scenes.object.splice(o,1)}var i=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.addTextToScene=function(t,e,i,o){function n(){var o=i.width?i.width:0,n=i.height?i.height:0,r=a.util.scalePosition({x:i.x,y:i.y,z:i.z},{x:a.sceneFloorWidth,y:-a.sceneFloorHeight,z:a.sceneFloorHeight}),s=ObjectFactory("SceneObject",o,n,r);s.sprite.children[0].setInnerHTML(e),i.size&&s.sprite.setCSS("font-size",i.size+"px"),i.color&&s.sprite.setCSS("color",i.color),(i.bgColor||i.bgImage)&&s.setBackground(o,n,i.bgImage?a.imgPath+i.bgImage:null,i.bgColor?i.bgColor:null),i.fade&&s.fadeIn(i.fade),s.name=t,a.sceneFloor.sprite.addChild(s.sprite),a.scenes.object.push(s)}var a=this;this.eventTracker.addEvent("nowait",n,o)},VisualNovel.prototype.fadeSceneText=function(t,e,i){this.fadeSceneObject(t,e,i)},VisualNovel.prototype.moveSceneText=function(t,e,i,o,n,a){this.moveSceneObject(t,e,i,o,n,a)},VisualNovel.prototype.rotateSceneText=function(t,e,i,o,n){this.rotateSceneObject(t,e,i,o,n)},VisualNovel.prototype.removeSceneText=function(t){this.removeSceneObject(t)},VisualNovel.prototype.moveCharacter=function(t,e,i,o){function n(){var n=a.getCharacter(t.name),r=n.sprite,s={x:e?e>1||-1>e?e:e*a.screenWidth:r.x,y:i?i>1||-1>i?i:i*a.screenHeight:r.y};n.move(s.x,s.y,0,o)}var a=this;this.eventTracker.addEvent("nowait",n)},VisualNovel.prototype.fadeCharacter=function(t,e,i,o,n){function a(){var a=r.getCharacter(t.name);"in"==e?a.fadeIn(i,o,n):"out"==e&&a.fadeOut(i,o,n)}var r=this;this.eventTracker.addEvent("nowait",a)},VisualNovel.prototype.flipCharacter=function(t){function e(){var e=i.getCharacter(t.name),o=e.sprite,n=o.scaleX>0?-1:1;o.setScaleX(n).update()}var i=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.addCharacter=function(t,e,i){function o(){r.screenCharacterId.style.display="block";var e=t.width/2,i=r.screenHeight-t.height+r.screenHeight*t.pos.y,o=r.screenWidth*t.pos.x,n={x:o,y:i,z:0},a={x:e,y:0,z:0},s=ObjectFactory("Character",t.width,t.height,n,a);return s.setBackground(t.width,t.height,r.getCharacterImage(t)),s.name=t.name,s}function n(t){r.characterContainer.addChild(t.sprite),r.characters.push(t)}function a(){var t=o();i&&t.fadeIn(e),n(t)}var r=this;this.eventTracker.addEvent("nowait",a,e)},VisualNovel.prototype.getCharacter=function(t){var e=this.util.getObjectInList(this.characters,"name",t);return e.obj},VisualNovel.prototype.getCharacterImage=function(t,e){var i=this.imgPath,o=t&&t.image?t.image:null;return o&&"object"==typeof o?(o=e?o[e]:o["default"],o="object"==typeof o?{src:i+o.src,position:o.position}:i+o):o&&(o=i+o),o},VisualNovel.prototype.changeCharacterImage=function(t,e){function i(){o.setCharacterImage(t,e)}var o=this;this.eventTracker.addEvent("nowait",i)},VisualNovel.prototype.setCharacterImage=function(t,e){var i=this.getCharacter(t.name),o=this.getCharacterImage(t,e);"object"==typeof o?(i.sprite.setCSS("background-image","url('"+o.src+"')"),i.sprite.setCSS("background-position",o.position)):i.sprite.setCSS("background-image","url('"+o+"')")},VisualNovel.prototype.removeCharacter=function(t,e,i){function o(){var e=a.util.getObjectInList(a.characters,"name",t.name),i=e.id;a.characterContainer.removeChildAt(i+1),a.characters.splice(i,1)}function n(){if(i){var n=a.getCharacter(t.name);n.fadeOut(e)}a.eventTracker.delayCallback(e,o)}var a=this;this.eventTracker.addEvent("nowait",n,e)},VisualNovel.prototype.removeAllCharacter=function(t){function e(){o.resetCharacters()}function i(){o.eventTracker.delayCallback(t,e)}var o=this;this.eventTracker.addEvent("nowait",i,t)},VisualNovel.prototype.resetCharacters=function(){for(var t=this.characterContainer.children,e=t.length,i=e-1;i>=1;i--)this.characterContainer.removeChildAt(i);this.characters=[]},VisualNovel.prototype.sayLine=function(t,e,i){function o(){var o=n.novelMode;n.setSayDialogDisplay(!0,o),n.buildSayDialog(t,e,i,o),n.updateSayDialogReference(n.novelId),"undefined"==typeof i&&(n.updateSayDialogButtonReference(n.novelId),n.updateDialogButtonPosition(t),n.refreshDialogButtonPositionView(t),n.updateDialogButtonListeners(t))}var n=this;this.eventTracker.addEvent(i?"nowait":"wait",o,i)},VisualNovel.prototype.sayLineExtend=function(t,e){function i(){var e=o.dialogTextId.innerHTML+t;o.dialogTextId.innerHTML=e}var o=this;this.eventTracker.addEvent(e?"nowait":"wait",i,e)},VisualNovel.prototype.sayMultipleLines=function(t,e){var i=this.util,o=e.length,n=[],a=[],r=null;i.foreach(e,function(t,i){a=[],"string"==typeof t&&(a.push(t),r=i+1,o>r&&"number"==typeof e[r]&&a.push(e[r]),o>r&&"boolean"==typeof e[r]?a.push(0,e[r]):o>r+1&&"boolean"==typeof e[r+1]&&a.push(e[r+1]),n.push(a))}),a=[],i.foreach(n,function(e){if("boolean"==typeof e[e.length-1])if(0===e[1]){var i=a.join("")+e[0];a=[],this.sayLine(t,i)}else a.push(e[0]),this.sayLineExtend.apply(this,e);else e[1]?a.push(e[0]):a=[],e.unshift(t),this.sayLine.apply(this,e)}.bind(this))},VisualNovel.prototype.say=function(t,e,i){var o=arguments.length,n="object"==typeof t,a="string"==typeof t,r=n||a;r&&"string"==typeof e&&(this.dialogCharacter=t,this.sayLine(t,e,i)),r&&this.util.isArray(e)&&(this.dialogCharacter=t,this.sayMultipleLines(t,e)),a&&(1===o||2===o&&"number"==typeof e)&&this.sayLine(this.dialogCharacter,t,e)},VisualNovel.prototype.buildSayDialog=function(t,e,i,o){var n=o?o:this.novelMode,a="novel"==n?"novelModeId":"dialogModeId",r=this.getSayTemplate(t,e,i);this[a].innerHTML=r},VisualNovel.prototype.getSayTemplate=function(t,e,i){var o=this.getSayTemplateVariables(t,e,i),n=this.templates.get("say");return n=this.parser.parseTemplate(n,o)},VisualNovel.prototype.getSayTemplateVariables=function(t,e,i){var o="object"==typeof t?t.name:t,n="object"==typeof t?t.nameStyle:"",a=this.util.replaceVariablesInText(e,this.userInput),r=t.dialog,s=r?!0:!1,l="",c="",u="",h="",d="",p=i?!1:!0,v="OK",g=!1,f="",y="",m="";if(s){l=r.image?this.imgPath+r.image:"",c=r.width?"width:"+r.width+"px;":"",u=r.height?"height:"+r.height+"px;":"",h=r.location?"float:"+r.location+";":"",d=h?"left"==h?"margin-right:10px;":"margin-left:10px;":"";var I=r.button;g=i?!1:I&&I.image?I.image:!1,f=g?this.imgPath+I.image:"",y=g?"width:"+I.width+"px;":"",m=g?"height:"+I.height+"px;":"",p=i||g?!1:I&&I.text?I.text:!0,v=I&&I.text?I.text:"OK"}var S={novelId:this.novelId,name:o,dialogNameStyle:n,dialogLine:a,showDialogImage:s,dialogImage:l,dialogImageStyle:h+c+u+d,showButtonText:p,dialogButtonText:v,showButtonImage:g,dialogButtonImage:f,dialogButtonImageStyle:y+m};return S},VisualNovel.prototype.updateSayDialogReference=function(t){var e=document;this.dialogImageId=e.getElementById(t+"-dialog-dialogImage"),this.dialogTextId=e.getElementById(t+"-dialog-dialogText")},VisualNovel.prototype.updateSayDialogButtonReference=function(t){this.dialogButtonId=document.getElementById(t+"-dialog-dialogButton")},VisualNovel.prototype.setSayDialogDisplay=function(t,e){var i=e?e:this.novelMode,o=t?"block":"none";"dialog"==i&&(this.dialogModeId.style.display=o,this.novelModeId.style.display="none"),"novel"==i&&(this.dialogModeId.style.display="none",this.novelModeId.style.display=o)},VisualNovel.prototype.showSayDialog=function(t){function e(){i.setSayDialogDisplay(t,i.novelMode)}var i=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.input=function(t,e){function i(){o.dialogMenuId.style.display="block",o.buildUserInputContainer(e),o.updateUserInputReference(o.novelId),o.userInputButtonId.onclick=function(){o.getInput(t)}}var o=this;this.eventTracker.addEvent("wait",i)},VisualNovel.prototype.buildUserInputContainer=function(t){this.dialogMenuId.innerHTML=this.getUserInputTemplate(t)},VisualNovel.prototype.getUserInputTemplate=function(t){var e={novelId:this.novelId,message:t},i=this.templates.get("userinput");return i=this.parser.parseTemplate(i,e)},VisualNovel.prototype.updateUserInputReference=function(t){var e=document;this.userInputTextId=e.getElementById(t+"-userInputText"),this.userInputButtonId=e.getElementById(t+"-userInputButton")},VisualNovel.prototype.getInput=function(t){var e=this.userInputTextId;this.userInput[t]=e.value,this.dialogMenuId.style.display="none",this.eventTracker.nextEvent()},VisualNovel.prototype.setInput=function(t,e){t&&(this.userInput[t]=e)},VisualNovel.prototype.setValue=function(t,e){function i(){o.setInput(t,e)}var o=this;this.eventTracker.addEvent("nowait",i)},VisualNovel.prototype.getValue=function(t){return this.userInput[t]},VisualNovel.prototype.resetNovelDialogText=function(){this.novelModeId.innerHTML="",this.dialogModeId.innerHTML=""},VisualNovel.prototype.addCondition=function(t,e,i,o,n){function a(){var a=!1,s=r.userInput;"="==e&&(a=s[t]==i),">"==e&&(a=s[t]>i),"<"==e&&(a=s[t]<i),"!="==e&&(a=s[t]!=i);var l=r.eventTracker,c=l.eventsInProgress.length,u=l.eventsInProgress[c-1]+"-condition-"+c;l.addNewEventInProgress(u),a?o():n(),r.eventTracker.startEvent()}var r=this;this.eventTracker.addEvent("wait",a)},VisualNovel.prototype.choice=function(t,e,i,o){function n(){a.dialogMenuId.style.display="block";for(var n=e.length,r=n,s=[];r--;)s.unshift(e[r]);a.menuChoices[t]=s,a.buildMenuChoices(e,o),a.updateMenuChoicesReference(a.novelId),a.addMenuChoicesHandler(t,n),i&&a.setMenuChoicesPosition(i.x,i.y),a.eventTracker.addNewEventInProgress(t)}var a=this;this.eventTracker.addEvent("wait",n)},VisualNovel.prototype.buildMenuChoices=function(t,e){var i=e?e:{image:"",width:0,height:0},o=this.imgPath+i.image,n=this.getMenuChoicesTemplate(t,o,i.width,i.height);this.dialogMenuId.innerHTML=n},VisualNovel.prototype.getMenuChoicesTemplate=function(t,e,i,o){var n={novelId:this.novelId,choices:t,imgPath:e,imgWidth:i,imgHeight:o},a=this.templates.get("menuchoice");return a=this.parser.parseTemplate(a,n)},VisualNovel.prototype.updateMenuChoicesReference=function(){this.dialogMenuChoiceContainerId=document.getElementById(this.novelId+"-dialogMenuChoiceContainer")},VisualNovel.prototype.addMenuChoicesHandler=function(t,e){for(var i=this,o=this.novelId,n=function(e){var o=e;return function(){i.dialogMenuId.style.display="none",i.performMenuChoice(t,o)}},a=e;a--;)document.getElementById(o+"-dialogMenuChoiceButton"+a).onclick=n(a)},VisualNovel.prototype.performMenuChoice=function(t,e){var i=this.menuChoices[t][e];this.menuChoicesTaken[t]=i;
var o=i.action;o(),this.resetMenuChoicesForEvent(t),this.eventTracker.startEvent()},VisualNovel.prototype.setMenuChoicesPosition=function(t,e){var i=this.util.scalePosition({x:t,y:e},{x:this.screenWidth,y:this.screenHeight});this.dialogMenuChoiceContainerId.style.cssText+=";left:"+i.x+"px;top:"+i.y+"px;"},VisualNovel.prototype.resetMenuChoicesForEvent=function(t){function e(){i.menuChoices[t]=[]}var i=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.resetMenuChoices=function(){this.menuChoices={},this.menuChoicesTaken={}},VisualNovel.prototype.loop=function(t,e,i,o){if(i){var n=this,a=o?o:100,r=function(){if(n.timers[t]&&(n.clearLoop(t),n.timers[t]=null),e===!0)n.timers[t]={type:"interval",timer:setInterval(function(){i()},a)};else if(e>0){var o=e,r=function(){i(),o--,s()},s=function(){n.timers[t].timer=o?setTimeout(r,a):null};n.timers[t]={type:"timeout",timer:null},s()}else i()};this.eventTracker.addEvent("nowait",r)}},VisualNovel.prototype.clearLoop=function(t){function e(){i.clearTimer(t)}var i=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.clearTimer=function(t){var e=this.timers[t];e&&("timeout"===e.type?clearTimeout(e.timer):"interval"===e.type&&clearInterval(e.timer),this.timers[t]=null)},VisualNovel.prototype.resetLoops=function(){var t=this.timers,e=null;for(var i in t)e=t[i]?t[i].type:null,!e||"timeout"!==e&&"interval"!==e||this.clearTimer(i)},VisualNovel.prototype.storeImage=function(t){this.images.push(t)},VisualNovel.prototype.preLoadImages=function(){},EventTracker.prototype.addEvent=function(t,e,i){var o=this.eventsInProgress,n=o[o.length-1];this.eventList[n].push({type:t,event:e,delay:i?i:0})},EventTracker.prototype.addNewEventInProgress=function(t){this.eventsInProgress.push(t),this.eventList[t]=[],this.eventId[t]=0},EventTracker.prototype.startEvent=function(){var t=this,e=$.Deferred(),i=this.eventsInProgress,o=i[i.length-1],n=this.eventList[o],a=this.eventId[o],r=n[a],s=r.type,l=r.delay;r.event(),this.delayCallback(l,function(){e.resolve()}),e.done(function(){"nowait"==s&&t.nextEvent()})},EventTracker.prototype.nextEvent=function(){var t=this.eventsInProgress,e=t.length,i=t[e-1],o=this.eventList[i],n=this.eventId;n[i]+=1;var a=n[i];a<o.length?this.startEvent():1==e||(t.pop(),this.doRepeatEvent?(this.doRepeatEvent=!1,this.startEvent()):this.nextEvent())},EventTracker.prototype.resetEventsInProgress=function(){this.eventsInProgress=["main"],this.eventId={main:0}},EventTracker.prototype.delayCallback=function(t,e){t?setTimeout(function(){e()},t):e()},Util.prototype.getObjectInList=function(t,e,i){for(var o={id:null,obj:null},n=t?t:[],a=n.length;a--;)n[a][e]==i&&(o={id:a,obj:n[a]});return o},Util.prototype.scalePosition=function(t,e){var i=t.x,o=t.y,n=t.z,a={x:i>1||-1>i?i:i*e.x,y:o>1||-1>o?o:o*e.y,z:n>1||-1>n?n:n*e.z};return a},Util.prototype.foreach=function(t,e,i){for(var o=t.length;o--;)i?e.call(i,t[o],o):e(t[o],o)},Util.prototype.replaceVariablesInText=function(t,e){var i=t+"",o="",n="",a=null;for(o in e)n=e[o],a=new RegExp("{"+o+"}","gi"),i=i.replace(a,n);return i},Util.prototype.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},Parser.prototype=Object.create(Util.prototype),Parser.prototype.constructor=Parser,Parser.prototype.parseTemplate=function(t,e){return t=this.parseConditionsInTemplate(t,e),t=this.replaceVariablesInText(t,e),t=this.parseLoopsInTemplate(t,e)},Parser.prototype.parseConditionsInTemplate=function(t,e){var i=t.slice(),o=[],n=i.split(/(<\s*if\s*[^>]*>(.|\n)*?<\s*\/\s*if>)/i);return this.foreach(n,function(t){""!==t&&">"!==t&&o.unshift(t)}),o.length>1&&this.foreach(o,function(t,i){var n=t.replace(/<if={(.*)}>.*<\/if>/i,"$1"),a=e[n],r=void 0===a?n:a?t.replace(/<if={.*}>(.*)<\/if>/i,"$1"):"";o[i]=r.slice()},this),i=o.join("")},Parser.prototype.parseLoopsInTemplate=function(t,e){var i=t.slice(),o=i.match(/<foreach={.*}>.*<\/foreach>/gi);if(o&&o.length>0){var n=[];this.foreach(o,function(t){var i=[],o=t.replace(/<foreach={.*}>(.*)<\/foreach>/gi,"$1"),a=t.replace(/<foreach={(.*)}>.*<\/foreach>/gi,"$1");a=a.split(" ");var r=a[2],s=a[0];this.foreach(e[r],function(t,e){var n=o.replace(/{index}/gi,e),a=new RegExp("{"+s+".(.*)}","gi");n=n.replace(a,"{$1}"),n=this.replaceVariablesInText(n,t),i.unshift(n)},this),n.push(i.join(""))},this),this.foreach(n,function(t){i=i.replace(/<foreach={.*}>.*<\/foreach>/i,t)})}return i},TemplateFactory.prototype.get=function(t){var e=this.templates,i=e[t]?e[t].join(""):"";return i},TemplateFactory.prototype.set=function(t,e){return this.templates[t]=e,this},Effect.prototype.perform=function(t,e,i,o,n){null===e.timer&&(e.timer={}),this[t]&&this[t](e,i,o,n)},Effect.prototype.fadeIn=function(t,e,i,o){var n=o&&o.step?o.step:1,a=o&&"undefined"!=typeof o.from&&o.from>=0?o.from:0,r=o&&"undefined"!=typeof o.to&&o.to>=0?o.to:100;this.fade(t,i,a,r,n)},Effect.prototype.fadeOut=function(t,e,i,o){var n=o&&o.step?o.step:-1,a=o&&"undefined"!=typeof o.from&&o.from>=0?o.from:100,r=o&&"undefined"!=typeof o.to&&o.to>=0?o.to:0;this.fade(t,i,a,r,n)},Effect.prototype.fade=function(t,e,i,o,n){var a=this,r=0>n?-1:1,s=i+r,l=0>n?s>=o&&i>=s:s>=i&&o>=s;l&&(t.setOpacity(s/100),t.timer.fade=setTimeout(function(){a.fade(t,e,s,o,n)},e/100))},Effect.prototype.move=function(t,e,i,o){var n=this,a=o.x,r=o.y,s=o.z,l={x:a?a>1||-1>a?a:a*n.screenWidth:t.x,y:r?r>1||-1>r?r:r*n.screenHeight:t.y,z:s?s>1||-1>s?s:s*n.screenHeight:t.x},c={x:a?Math.abs(l.x-t.x):0,y:r?Math.abs(l.y-t.y):0,z:s?Math.abs(l.z-t.z):0};if(null===t.moveStep){var u={x:a?t.x<l.x?c.x/100:-c.x/100:0,y:r?t.y<l.y?c.y/100:-c.y/100:0,z:s?t.z<l.z?c.z/100:-c.z/100:0};u.x=a?t.x==l.x?0:Math.round(u.x):0,u.y=r?t.y==l.y?0:Math.round(u.y):0,u.z=s?t.z==l.z?0:Math.round(u.z):0,t.moveStep=u}var h=t.moveStep,d=h.x>0?t.x<l.x:t.x>l.x,p=h.y>0?t.y<l.y:t.y>l.y,v=h.z>0?t.z<l.z:t.z>l.z;d||p||v?(t.x=a?t.x+h.x:t.x,t.y=r?t.y+h.y:t.y,t.z=s?t.z+h.z:t.z,t.update(),t.timer.move=setTimeout(function(){n.move(t,e,i,o)},i/100)):t.moveStep=null},Effect.prototype.rotate=function(t,e,i,o){var n=o.axis,a=o.angle,r=t,s=null;"y"==n&&(s=function(){r.rotateY(a)}),"z"==n&&(s=function(){r.rotateZ(a)}),t.timer.rotate=i>=0?setTimeout(function(){s(),r.update()},i):setInterval(function(){s(),r.update()},-i)},Sprite.prototype.init=function(t,e,i,o,n){var a=this.createSprite(t,e,i,o,n);this.sprite=a},Sprite.prototype.createSprite=function(t,e,i,o,n){var a=i,r=o.x,s=o.y,l=o.z,c=(new Sprite3D).setClassName("sprite").setSize(t,e).setTransformOrigin(r,s,l).setPosition(a.x,a.y,a.z).rotateX(n&&n.x?n.x:0).rotateY(n&&n.y?n.y:0).rotateZ(n&&n.z?n.z:0).setRotateFirst(!0);return c.setCSS("-webkit-transform-origin",r+"px "+s+"px").update(),c.timer={},c},Sprite.prototype.setBackground=function(t,e,i,o){var n=t&&e?"background-size:"+t+"px "+e+"px;":"",a=i?"background-image:url('"+i+"');":"",r=o?"background-color:"+o+";":"",s=n||a||r?";":"";this.sprite.style.cssText+=s+n+a+r},Sprite.prototype.move=function(t,e,i,o){var n=this,a=this.sprite,r=a.x,s=a.y,l=a.z,c=t?t:r,u=e?e:s,h=i?i:l;if("undefined"==typeof a.moveStep||null===a.moveStep){var d=0,p=0,v=0;if(t&&r!==c){var g=Math.abs(c-r)/100;d=c>r?g:-g,d=Math.round(d)}if(e&&s!==u){var f=Math.abs(u-s)/100;p=u>s?f:-f,p=Math.round(p)}if(i&&l!==h){var y=Math.abs(h-l)/100;v=h>l?y:-y,v=Math.round(v)}a.moveStep={x:d,y:p,z:v}}var m=a.moveStep,I=m.x>0?c>r:r>c,S=m.y>0?u>s:s>u,C=m.z>0?h>l:l>h;I||S||C?(a.x=t?r+m.x:r,a.y=e?s+m.y:s,a.z=i?l+m.z:l,a.update(),a.timer.move=setTimeout(function(){n.move(t,e,i,o)},o?o/100:0)):a.moveStep=null},Sprite.prototype.moveTo=function(t,e,i,o){var n=o?o:this.sprite;n.x=t,n.y=e,n.z=i,n.update()},Sprite.prototype.rotate=function(t,e,i,o,n){var a=n?n:this.sprite,r=function(){},s=i?i:0;t&&(r=function(){a["rotate"+t.toUpperCase()](e).update()}),a.timer.rotate=o?setInterval(function(){r()},s):setTimeout(function(){r()},s)},Sprite.prototype.rotateTo=function(t,e,i,o){var n=this,a=o?o:this.sprite,r=t.toUpperCase(),s=a["rotation"+r];if(s!=e){var l=e>=0?1:-1,c=function(){a["setRotation"+r](s+l).update()};a.timer.rotate=setTimeout(function(){c(),n.rotateTo(t,e,i,o)},i?i:0)}else a.timer.rotate=null},Sprite.prototype.fade=function(t,e,i,o){var n=t+i,a=0>i?n>=e&&t>=n:n>=t&&e>=n;if(a){var r=this,s=this.sprite;s.setOpacity(n/100),s.timer.fade=setTimeout(function(){r.fade(n,e,i,o)},o/100)}},Sprite.prototype.fadeIn=function(t,e,i){var o=e&&e>0?e:0,n=i&&i>0?i:100;this.fade(o,n,1,t)},Sprite.prototype.fadeOut=function(t,e,i){var o=e&&e>0?e:100,n=i&&i>0?i:0;this.fade(o,n,-1,t)},Character.prototype=Object.create(Sprite.prototype),Character.prototype.constructor=Character,Character.prototype.setBackground=function(t,e,i,o){var n="",a="";"object"==typeof i?(a=i&&i.src?"background-image:url('"+i.src+"');":"",a+=a&&i.position?"background-position:"+i.position+";":""):(n=t&&e?"background-size:"+t+"px "+e+"px;":"",a=i?"background-image:url('"+i+"');":a);var r=o?"background-color:"+o+";":"",s=n||a||r?";":"";this.sprite.style.cssText+=s+n+a+r},SceneObject.prototype=Object.create(Sprite.prototype),SceneObject.prototype.constructor=SceneObject,SceneObject.prototype.init=function(t,e,i){var o={x:i.x-25,y:i.z,z:i.y},n={x:i.x+t/2,y:0},a=this.createSprite(50,50,o,n);o={x:-(t/2)+25,y:-e,z:0},n={x:25,y:0,z:0};var r={x:110,y:0,z:0},s=this.createSprite(t,e,o,n,r);s.update(),a.addChild(s),this.sprite=a},SceneObject.prototype.setBackground=function(t,e,i,o){var n=this.sprite.children[0],a=t&&e?"background-size:"+t+"px "+e+"px;":"",r=i?"background-image:url('"+i+"');":"",s=o?"background-color:"+o+";":"",l=a||r||s?";":"";n.style.cssText+=l+a+r+s},SceneObject.prototype.rotate=function(t,e,i,o){var n=this.sprite.children[0];Sprite.prototype.rotate.call(this,t,e,i,o,n)},SceneObject.prototype.rotateTo=function(t,e,i){var o=this.sprite.children[0];Sprite.prototype.rotateTo.call(this,t,e,i,o)};